<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planeta X ‚Äì Konfiguracja i Diagnostyka</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet"/>
  <script src="progress.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #0a0b10; font-family: 'Nunito', system-ui, sans-serif; color: #c0caf5; min-height: 100vh; }
    .nav { background: #0f1019; border-bottom: 2px solid #1e2030; padding: 12px 24px; display: flex; align-items: center; gap: 16px; }
    .nav a { color: #7aa2f7; text-decoration: none; font-weight: 700; font-size: 14px; }
    .nav .title { font-weight: 900; font-size: 18px; color: #c0caf5; }
    .container { max-width: 1100px; margin: 0 auto; padding: 32px 24px; }
    h1 { font-size: 28px; font-weight: 900; margin-bottom: 8px; }
    .subtitle { color: #7982a9; font-size: 15px; margin-bottom: 32px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 32px; }
    .card { background: #12141e; border: 2px solid #1e2030; border-radius: 16px; padding: 20px; }
    .card h2 { font-size: 16px; font-weight: 800; margin-bottom: 16px; color: #7aa2f7; }
    .mission-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #1e2030; }
    .mission-row:last-child { border-bottom: none; }
    .mission-name { font-weight: 700; font-size: 14px; }
    .mission-badge { font-size: 12px; padding: 3px 10px; border-radius: 20px; font-weight: 700; }
    .badge-done { background: #73daca22; color: #73daca; border: 1px solid #73daca44; }
    .badge-progress { background: #7aa2f722; color: #7aa2f7; border: 1px solid #7aa2f744; }
    .badge-none { background: #5a608222; color: #5a6082; border: 1px solid #5a608244; }
    .progress-bar { width: 100%; height: 6px; background: #1e2030; border-radius: 100px; overflow: hidden; margin-top: 4px; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #7aa2f7, #73daca); border-radius: 100px; }
    .btn { background: #7aa2f722; color: #7aa2f7; border: 1px solid #7aa2f744; border-radius: 10px; padding: 8px 18px; cursor: pointer; font-family: inherit; font-size: 14px; font-weight: 700; transition: background 0.2s; }
    .btn:hover { background: #7aa2f744; }
    .btn-danger { background: #f7768e22; color: #f7768e; border-color: #f7768e44; }
    .btn-danger:hover { background: #f7768e44; }
    .btn-green { background: #73daca22; color: #73daca; border-color: #73daca44; }
    .btn-green:hover { background: #73daca44; }
    .btn-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 16px; }
    .log-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .log-table th { text-align: left; padding: 8px 10px; color: #7982a9; font-weight: 700; border-bottom: 2px solid #1e2030; }
    .log-table td { padding: 6px 10px; border-bottom: 1px solid #1e203066; font-family: 'JetBrains Mono', monospace; font-size: 12px; }
    .log-table tr:last-child td { border-bottom: none; }
    .level-info { color: #7aa2f7; }
    .level-warn { color: #e0af68; }
    .level-error { color: #f7768e; }
    .level-debug { color: #7982a9; }
    .config-row { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #1e2030; }
    .config-row:last-child { border-bottom: none; }
    .config-key { font-family: 'JetBrains Mono', monospace; font-size: 13px; color: #73daca; min-width: 200px; }
    .config-val { font-family: 'JetBrains Mono', monospace; font-size: 13px; color: #a9b1d6; flex: 1; word-break: break-all; }
    .config-ts { font-size: 11px; color: #5a6082; min-width: 140px; text-align: right; }
    .section-full { grid-column: 1 / -1; }
    .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
    .tab { padding: 6px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 700; border: 2px solid #1e2030; background: transparent; color: #7982a9; font-family: inherit; }
    .tab.active { background: #7aa2f722; color: #7aa2f7; border-color: #7aa2f744; }
    .empty { color: #5a6082; font-size: 14px; text-align: center; padding: 24px; }
    .api-status { font-size: 13px; padding: 6px 12px; border-radius: 8px; margin-left: auto; }
    .api-ok { background: #73daca22; color: #73daca; }
    .api-err { background: #f7768e22; color: #f7768e; }
    @media (max-width: 700px) { .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="nav">
    <a href="index.html">‚Üê Centrum Misji</a>
    <span class="title">üîß Konfiguracja i Diagnostyka</span>
    <span id="api-status" class="api-status api-err">API offline</span>
  </div>
  <div class="container">
    <h1>üìä Panel Diagnostyczny</h1>
    <p class="subtitle">Postƒôp misji, logi systemowe i konfiguracja. Dane z localStorage (zawsze) i SQLite API (je≈õli uruchomione).</p>

    <div class="grid">
      <!-- Mission Progress -->
      <div class="card">
        <h2>üöÄ Postƒôp misji</h2>
        <div id="missions-list"><div class="empty">≈Åadowanie...</div></div>
        <div class="btn-row">
          <button class="btn btn-green" onclick="downloadProgress()">‚¨áÔ∏è Pobierz JSON</button>
          <button class="btn btn-danger" onclick="resetProgress()">üóëÔ∏è Resetuj postƒôp</button>
        </div>
      </div>

      <!-- Config -->
      <div class="card">
        <h2>‚öôÔ∏è Konfiguracja (localStorage)</h2>
        <div id="config-list"><div class="empty">≈Åadowanie...</div></div>
        <div class="btn-row">
          <button class="btn" onclick="loadConfig()">üîÑ Od≈õwie≈º</button>
          <button class="btn btn-green" onclick="downloadConfig()">‚¨áÔ∏è Pobierz</button>
        </div>
      </div>

      <!-- Logs -->
      <div class="card section-full">
        <h2>üìã Logi systemowe</h2>
        <div class="tabs">
          <button class="tab active" onclick="filterLogs('all', this)">Wszystkie</button>
          <button class="tab" onclick="filterLogs('info', this)">Info</button>
          <button class="tab" onclick="filterLogs('warn', this)">Warn</button>
          <button class="tab" onclick="filterLogs('error', this)">Error</button>
        </div>
        <div id="logs-container" style="overflow-x:auto;max-height:400px;overflow-y:auto;">
          <div class="empty">≈Åadowanie log√≥w...</div>
        </div>
        <div class="btn-row">
          <button class="btn" onclick="loadLogs()">üîÑ Od≈õwie≈º</button>
          <button class="btn btn-green" onclick="downloadLogs()">‚¨áÔ∏è Pobierz logi</button>
          <button class="btn btn-danger" onclick="clearLogs()">üóëÔ∏è Wyczy≈õƒá logi</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const pm = new ProgressManager();
    const API = 'http://localhost:3001/api';
    let allLogs = [];
    let currentFilter = 'all';

    const MISSIONS = [
      { id: 'przylot', title: 'üöó Przylot na Planetƒô X' },
      { id: 'cyberquest', title: 'üõ°Ô∏è CyberQuest' },
      { id: 'serwer', title: 'üåê Serwer Planety X' },
      { id: 'automatyzacja', title: 'ü§ñ Automatyzacja' },
      { id: 'konteneryzacja', title: 'üê≥ Konteneryzacja' },
      { id: 'kod', title: 'üß¨ Kod Planety X' },
    ];

    async function checkAPI() {
      try {
        const r = await fetch(API + '/progress/missions/completed', { signal: AbortSignal.timeout(2000) });
        if (r.ok) { document.getElementById('api-status').textContent = '‚úÖ API online'; document.getElementById('api-status').className = 'api-status api-ok'; return true; }
      } catch {}
      document.getElementById('api-status').textContent = '‚ö†Ô∏è API offline (tylko localStorage)';
      document.getElementById('api-status').className = 'api-status api-err';
      return false;
    }

    function renderMissions() {
      const el = document.getElementById('missions-list');
      el.innerHTML = MISSIONS.map(m => {
        const complete = pm.backend.isMissionComplete(m.id);
        const prog = pm.backend.getProgress(m.id);
        const pct = prog.percent;
        const badge = complete ? '<span class="mission-badge badge-done">üèÜ Uko≈Ñczona</span>'
          : pct > 0 ? `<span class="mission-badge badge-progress">${pct}%</span>`
          : '<span class="mission-badge badge-none">Nie rozpoczƒôta</span>';
        return `<div class="mission-row">
          <div>
            <div class="mission-name">${m.title}</div>
            <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
            <div style="font-size:11px;color:#5a6082;margin-top:2px;">${prog.completed}/${prog.total} krok√≥w</div>
          </div>
          ${badge}
        </div>`;
      }).join('');
    }

    function renderConfig() {
      const el = document.getElementById('config-list');
      const keys = Object.keys(localStorage).filter(k => k.startsWith('planetax_'));
      if (!keys.length) { el.innerHTML = '<div class="empty">Brak danych konfiguracyjnych</div>'; return; }
      el.innerHTML = keys.sort().map(k => {
        const v = localStorage.getItem(k);
        return `<div class="config-row">
          <span class="config-key">${k.replace('planetax_','')}</span>
          <span class="config-val">${v.length > 60 ? v.substring(0,60)+'‚Ä¶' : v}</span>
        </div>`;
      }).join('');
    }

    async function loadLogs() {
      const el = document.getElementById('logs-container');
      // Try API first
      try {
        const r = await fetch(API + '/logs?limit=500', { signal: AbortSignal.timeout(2000) });
        if (r.ok) { const d = await r.json(); allLogs = d.logs; renderLogs(); return; }
      } catch {}
      // Fallback: localStorage logs
      const stored = localStorage.getItem('planetax_logs');
      allLogs = stored ? JSON.parse(stored) : [];
      if (!allLogs.length) { el.innerHTML = '<div class="empty">Brak log√≥w (API offline, brak log√≥w w localStorage)</div>'; return; }
      renderLogs();
    }

    function renderLogs() {
      const el = document.getElementById('logs-container');
      const filtered = currentFilter === 'all' ? allLogs : allLogs.filter(l => l.level === currentFilter);
      if (!filtered.length) { el.innerHTML = '<div class="empty">Brak log√≥w dla wybranego filtra</div>'; return; }
      el.innerHTML = `<table class="log-table">
        <thead><tr><th>Czas</th><th>Poziom</th><th>Misja</th><th>Zdarzenie</th><th>Dane</th></tr></thead>
        <tbody>${filtered.map(l => `<tr>
          <td>${l.ts || l.timestamp || ''}</td>
          <td class="level-${l.level}">${l.level}</td>
          <td>${l.mission_id || l.missionId || '‚Äî'}</td>
          <td>${l.event}</td>
          <td style="color:#5a6082">${l.data ? (l.data.length > 50 ? l.data.substring(0,50)+'‚Ä¶' : l.data) : '‚Äî'}</td>
        </tr>`).join('')}</tbody>
      </table>`;
    }

    function filterLogs(level, btn) {
      currentFilter = level;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      renderLogs();
    }

    async function clearLogs() {
      if (!confirm('Wyczy≈õciƒá wszystkie logi?')) return;
      try { await fetch(API + '/logs', { method: 'DELETE' }); } catch {}
      localStorage.removeItem('planetax_logs');
      allLogs = [];
      renderLogs();
    }

    function downloadProgress() {
      const data = pm.backend.exportData();
      download('planetax-progress.json', JSON.stringify(data, null, 2));
    }

    function downloadConfig() {
      const data = {};
      Object.keys(localStorage).filter(k => k.startsWith('planetax_')).forEach(k => { data[k] = localStorage.getItem(k); });
      download('planetax-config.json', JSON.stringify(data, null, 2));
    }

    function downloadLogs() {
      download('planetax-logs.json', JSON.stringify(allLogs, null, 2));
    }

    function download(filename, content) {
      const a = document.createElement('a');
      a.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(content);
      a.download = filename;
      a.click();
    }

    function resetProgress() {
      if (!confirm('Zresetowaƒá ca≈Çy postƒôp? Tej operacji nie mo≈ºna cofnƒÖƒá!')) return;
      pm.backend.resetAll();
      renderMissions();
    }

    async function init() {
      await checkAPI();
      renderMissions();
      renderConfig();
      await loadLogs();
    }

    init();
  </script>
</body>
</html>
